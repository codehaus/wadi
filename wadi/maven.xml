<project
  default="java:jar"
  xmlns:j="jelly:core"
  xmlns:define="jelly:define"
  xmlns:ant="jelly:ant"
  xmlns:maven="jelly:maven"
  xmlns:aspectj="jelly:aspectj"
  xmlns:clover="jelly:clover"
  >

  <goal name="default" prereqs="clean, test"/>

  <goal name="dc" prereqs="clean, site:deploy, jar:deploy-snapshot"/>

<!--
  <goal name="maven-linkcheck-plugin"/>
  <goal name="maven-linkcheck-plugin:register"/>
  <goal name="maven-linkcheck-plugin:report-real"/>
-->

  <!-- ======================================== -->

  <!-- aspectj, it could be easier... -->

  <postGoal name="clean">
    <delete dir="${maven.build.dest}.javac"/>
    <delete dir="${maven.test.dest}.javac"/>
    <delete dir="${maven.clover.build.classes}.javac"/>
  </postGoal>

  <preGoal name="java:compile">
    <j:set var="wadi.maven.build.dest" value="${maven.build.dest}"/>
    <maven:set plugin="maven-java-plugin" property="maven.build.dest" value="${wadi.maven.build.dest}.javac"/>
    <ant:echo>### switching output dir ${wadi.maven.build.dest} to ${wadi.maven.build.dest}.javac</ant:echo>
    <ant:mkdir dir="${wadi.maven.build.dest}.javac"/>
  </preGoal>

  <postGoal name="java:compile">
    <maven:set plugin="maven-java-plugin" property="maven.build.dest" value="${wadi.maven.build.dest}"/>
    <ant:echo>### switching output dir ${wadi.maven.build.dest}.javac back to ${wadi.maven.build.dest}</ant:echo>
    <j:set var="wadi.dest" value="${wadi.maven.build.dest}"/>
    <attainGoal name="aspectj:compile-and-weave"/>
  </postGoal>

  <preGoal name="test:compile">
    <j:set var="wadi.maven.test.dest" value="${maven.test.dest}"/>
    <maven:set plugin="maven-test-plugin" property="maven.test.dest" value="${wadi.maven.test.dest}.javac"/>
    <ant:echo>### switching output dir ${wadi.maven.test.dest} to ${wadi.maven.test.dest}.javac</ant:echo>
    <ant:mkdir dir="${wadi.maven.test.dest}.javac"/>
  </preGoal>

  <postGoal name="test:compile">
    <maven:set plugin="maven-test-plugin" property="maven.test.dest" value="${wadi.maven.test.dest}"/>
    <ant:echo>### switching output dir ${wadi.maven.test.dest}.javac back to ${wadi.maven.test.dest}</ant:echo>
    <j:set var="wadi.dest" value="${wadi.maven.test.dest}"/>
    <attainGoal name="aspectj:compile-and-weave"/>
  </postGoal>

  <goal name="aspectj:compile-and-weave" prereqs="aspectj:init">
    <ant:echo>### compiling and weaving to ${wadi.dest}</ant:echo>
    <delete dir="${wadi.dest}"/>
    <ant:iajc
      destdir="${wadi.dest}"
      debug="true"
      verbose="true"
      time="true"
      source="1.4"
      >
      <ant:sourceroots>
      	<ant:pathelement path="${pom.build.aspectSourceDirectory}"/>
      </ant:sourceroots>
      <ant:classpath>
	<ant:path refid="maven.dependency.classpath"/>
	<ant:pathelement path="${wadi.maven.build.dest}.javac"/>
      </ant:classpath>
      <ant:inpath>
	<ant:pathelement path="${wadi.maven.build.dest}.javac"/>
	<ant:pathelement path="${wadi.dest}.javac"/>
      </ant:inpath>
    </ant:iajc>
  </goal>

  <!-- ======================================== -->

</project>
